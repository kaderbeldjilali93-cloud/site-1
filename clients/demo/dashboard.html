<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoPro | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</title>
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Chart.js Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Tailwind CSS Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                        latin: ['system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            DEFAULT: '#FF9900',
                            dark: '#CC7A00',
                        },
                        ticket: {
                            header: '#374151',
                            body: '#1F2937',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #111827; color: #fff; transition: all 0.3s ease; }
        .hidden-section { display: none; }
        iframe { border: none; width: 100%; height: 100%; }
        /* ØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ Ø®ÙÙŠÙ */
        .glass {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader-container {
            position: absolute;
            inset: 0;
            background: #1f2937;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF9900; }
        
        .live-indicator {
            width: 8px; height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        @keyframes flashYellow {
            0%, 100% { border-color: #4b5563; box-shadow: none; }
            50% { border-color: #eab308; box-shadow: 0 0 20px rgba(234, 179, 8, 0.6); }
        }
        .animate-new-order {
            animation: flashYellow 1.5s ease-in-out 4;
            border: 2px solid transparent; 
        }

        @keyframes flashGreen {
            0%, 100% { border-color: #4b5563; box-shadow: none; }
            50% { border-color: #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); }
        }
        .animate-ready-order {
            animation: flashGreen 1.5s ease-in-out 4;
            border: 2px solid transparent;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© */
        @media print {
            @page { size: 80mm auto; margin: 0; }
            body { background-color: #fff !important; color: #000 !important; margin: 0 !important; padding: 0 !important; font-family: sans-serif !important; }
            body > *:not(#print-section) { display: none !important; }
            #print-section { display: block !important; width: 80mm !important; margin: 0 auto !important; padding: 5mm !important; font-size: 12px !important; line-height: 1.4 !important; color: #000 !important; }
        }

        /* Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ© */
        html[dir="ltr"] .sidebar-text { text-align: left; }
        html[dir="rtl"] .sidebar-text { text-align: right; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="print-section" class="hidden"></div>

    <!-- ========================================== -->
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <!-- ========================================== -->
    <section id="login-screen" class="flex-grow flex items-center justify-center p-4 relative">
        <div class="absolute inset-0 overflow-hidden z-0 opacity-20">
            <div class="absolute top-0 left-0 w-64 h-64 bg-brand rounded-full mix-blend-multiply filter blur-3xl animate-pulse"></div>
            <div class="absolute bottom-0 right-0 w-64 h-64 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl animate-pulse"></div>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div class="absolute top-5 right-5 z-20">
            <div class="relative inline-block text-right" id="lang-dropdown-login-container">
                <button onclick="toggleLangDropdown('login')" class="flex items-center gap-2 bg-gray-800 border border-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-700 transition">
                    <span id="current-lang-flag-login">ğŸ‡©ğŸ‡¿</span>
                    <span id="current-lang-name-login">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                </button>
                <div id="lang-dropdown-login" class="hidden absolute left-0 mt-2 w-40 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl z-50 overflow-hidden">
                    <button onclick="setLanguage('ar')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡©ğŸ‡¿</span> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                    <button onclick="setLanguage('fr')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡«ğŸ‡·</span> FranÃ§ais</button>
                    <button onclick="setLanguage('en')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡ºğŸ‡¸</span> English</button>
                </div>
            </div>
        </div>

        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md z-10 border-t-4 border-brand">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-white mb-2 tracking-wide">Resto<span class="text-brand">Pro</span></h1>
                <p id="login-subtitle" class="text-gray-400 text-sm">Ø¨ÙˆØ§Ø¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø°ÙƒÙŠØ©</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label id="label-user" class="block text-sm font-medium text-gray-300 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… (Ø¬Ø±Ø¨: demo)</label>
                    <input type="text" id="restaurantName" required 
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition text-white"
                        placeholder="">
                </div>
                
                <div>
                    <label id="label-pass" class="block text-sm font-medium text-gray-300 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" required 
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition text-white"
                        placeholder="">
                </div>

                <button type="submit" id="btn-login-text" 
                    class="w-full bg-brand hover:bg-brand-dark text-black font-bold py-3 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </form>
            <p class="mt-6 text-center text-xs text-gray-500">Â© 2026 RestoPro Systems</p>
        </div>
    </section>

    <!-- ========================================== -->
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <!-- ========================================== -->
    <section id="dashboard-screen" class="h-full flex flex-col" style="display: none;">
        
        <header class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="bg-brand text-black font-bold rounded-lg p-2 text-xl">RP</div>
                <h2 class="font-bold text-lg leading-tight hidden sm:block">Resto<span class="text-brand">Pro</span></h2>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© -->
                <div class="relative inline-block text-right" id="lang-dropdown-container">
                    <button onclick="toggleLangDropdown('header')" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 p-2 rounded transition border border-gray-700">
                        <span id="current-lang-flag">ğŸ‡©ğŸ‡¿</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="lang-dropdown-header" class="hidden absolute left-0 mt-2 w-40 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl z-50 overflow-hidden">
                        <button onclick="setLanguage('ar')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡©ğŸ‡¿</span> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                        <button onclick="setLanguage('fr')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡«ğŸ‡·</span> FranÃ§ais</button>
                        <button onclick="setLanguage('en')" class="w-full text-right px-4 py-2 hover:bg-gray-700 transition flex items-center gap-2"><span>ğŸ‡ºğŸ‡¸</span> English</button>
                    </div>
                </div>

                <button id="btn-mute" onclick="toggleMute()" class="text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 p-2 rounded transition">
                    <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                </button>

                <button onclick="logout()" id="logout-btn-text" class="text-sm text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded transition">
                    Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="fixed inset-y-0 right-0 z-40 transform translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out w-64 bg-gray-900 border-l border-gray-800 flex flex-col justify-between flex-shrink-0 pt-16 md:pt-0">
                <nav class="p-2 space-y-2 mt-4">
                    <button onclick="loadView('kds')" id="btn-kds" class="nav-btn w-full block text-right px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition relative"><span class="sidebar-text" id="nav-kds">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span></button>
                    <button onclick="loadView('cashier')" id="btn-cashier" class="nav-btn w-full block text-right px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition relative"><span class="sidebar-text" id="nav-cashier">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></button>
                    <button onclick="loadView('tables')" id="btn-tables" class="nav-btn w-full block text-right px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition relative"><span class="sidebar-text" id="nav-tables">Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª</span><span id="tables-badge" class="absolute top-3 left-4 flex h-3 w-3 hidden"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span></button>
                    <button onclick="loadView('menu')" id="btn-menu" class="nav-btn w-full block text-right px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition relative"><span class="sidebar-text" id="nav-menu">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span></button>
                    <button onclick="loadView('analytics')" id="btn-analytics" class="nav-btn w-full block text-right px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition relative"><span class="sidebar-text" id="nav-analytics">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></button>
                </nav>
            </aside>

            <main class="flex-1 bg-gray-800 relative overflow-hidden flex flex-col">
                <div id="loader" class="loader-container hidden"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-brand"></div></div>
                <div id="welcome-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500"><h3 id="welcome-title" class="text-xl font-bold text-gray-300">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3><p id="welcome-desc" class="mt-2 text-sm">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡</p></div>
                <div id="dynamic-content" class="hidden flex-1 overflow-y-auto p-6 bg-gray-800 relative"></div>
            </main>
        </div>
    </section>

    <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ÙˆØ§Ù„ØªØ­ØµÙŠÙ„ -->
    <div id="checkout-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-md transition-opacity">
        <div class="relative bg-gray-800 border-t-4 border-brand rounded-2xl shadow-[0_0_40px_rgba(0,0,0,0.8)] p-6 w-full max-w-sm mx-4 transform transition-all scale-100">
            <button onclick="closeCheckoutModal()" class="absolute top-4 left-4 text-gray-500 hover:text-white transition focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-center gap-3 mb-6 border-b border-gray-700 pb-4 pr-6">
                <h3 id="checkout-title" class="text-xl font-bold text-white">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</h3>
            </div>
            <div class="bg-gray-900 rounded-xl p-6 text-center mb-6 border border-gray-700">
                <p id="checkout-amount-label" class="text-gray-400 text-sm mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                <div id="checkout-amount" class="text-4xl font-extrabold text-brand tracking-wider">0 DA</div>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="confirmPayment(true)" class="w-full bg-brand hover:bg-brand-dark text-black font-bold py-3 rounded-lg transition" id="btn-confirm-print">ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="confirmPayment(false)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition" id="btn-confirm-no-print">ØªØ£ÙƒÙŠØ¯ ÙÙ‚Ø·</button>
            </div>
        </div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙˆØ³Øª -->
    <div id="toast-container" class="fixed bottom-5 left-5 z-[60] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        // =========================================================
        // ğŸŒ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© (Localization System)
        // =========================================================
        const TRANSLATIONS = {
            ar: {
                app_name: "RestoPro",
                login_subtitle: "Ø¨ÙˆØ§Ø¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø°ÙƒÙŠØ©",
                label_user: "Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…",
                label_pass: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
                btn_login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                nav_kds: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
                nav_cashier: "Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
                nav_tables: "Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª",
                nav_menu: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
                nav_analytics: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
                logout: "Ø®Ø±ÙˆØ¬",
                welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
                choose: "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡",
                kds_title: "Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ø¨Ø®",
                tab_tables: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª",
                tab_quick: "Ø·Ù„Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
                tab_delivery: "Ø§Ù„ØªÙˆØµÙŠÙ„",
                table_empty: "ÙØ§Ø±ØºØ©",
                order: "Ø·Ù„Ø¨",
                ready: "Ø¬Ø§Ù‡Ø²",
                cooking: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±",
                paid: "Ù…Ø¯ÙÙˆØ¹",
                total_sales: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
                total_orders: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
                avg_cart: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ù„Ø©",
                checkout: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",
                amount_label: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ù‡",
                btn_confirm_print: "ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©",
                btn_confirm_no_print: "ØªØ£ÙƒÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø·Ø¨Ø§Ø¹Ø©",
                toast_success: "ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…",
                toast_error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§ âŒ",
                receipt_header: "RestoPro - Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ©",
                receipt_footer: "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!"
            },
            fr: {
                app_name: "RestoPro",
                login_subtitle: "Portail de gestion intelligente",
                label_user: "Nom du restaurant",
                label_pass: "Mot de passe",
                btn_login: "Se connecter",
                nav_kds: "Commandes KDS",
                nav_cashier: "Caisse & Ventes",
                nav_tables: "Appels de Table",
                nav_menu: "GÃ©rer le Menu",
                nav_analytics: "Statistiques",
                logout: "Quitter",
                welcome: "Bienvenue sur le Dashboard",
                choose: "Choisissez une option pour commencer",
                kds_title: "Ã‰cran Cuisine (KDS)",
                tab_tables: "Salles",
                tab_quick: "EmportÃ©",
                tab_delivery: "Livraison",
                table_empty: "Libre",
                order: "Cmd",
                ready: "PrÃªt",
                cooking: "En cours",
                paid: "PayÃ©",
                total_sales: "Ventes Totales",
                total_orders: "Nb Commandes",
                avg_cart: "Panier Moyen",
                checkout: "Confirmer Paiement",
                amount_label: "Montant Ã  encaisser",
                btn_confirm_print: "Confirmer & Imprimer",
                btn_confirm_no_print: "Confirmer seulement",
                toast_success: "OpÃ©ration rÃ©ussie âœ…",
                toast_error: "Une erreur est survenue âŒ",
                receipt_header: "RestoPro - Gestion Intelligente",
                receipt_footer: "Merci de votre visite !"
            },
            en: {
                app_name: "RestoPro",
                login_subtitle: "Smart Restaurant Management",
                label_user: "Restaurant Name",
                label_pass: "Password",
                btn_login: "Login",
                nav_kds: "Live Orders (KDS)",
                nav_cashier: "Sales Record",
                nav_tables: "Table Calls",
                nav_menu: "Menu Editor",
                nav_analytics: "Analytics",
                logout: "Logout",
                welcome: "Welcome to Dashboard",
                choose: "Choose from sidebar to start",
                kds_title: "Kitchen Screen (KDS)",
                tab_tables: "Table Orders",
                tab_quick: "Quick Orders",
                tab_delivery: "Delivery",
                table_empty: "Empty",
                order: "Order",
                ready: "Ready",
                cooking: "Preparing",
                paid: "Paid",
                total_sales: "Total Sales",
                total_orders: "Total Orders",
                avg_cart: "Average Cart",
                checkout: "Confirm Payment",
                amount_label: "Amount to collect",
                btn_confirm_print: "Confirm & Print Receipt",
                btn_confirm_no_print: "Confirm Only",
                toast_success: "Success âœ…",
                toast_error: "Error occurred âŒ",
                receipt_header: "RestoPro - Smart Management",
                receipt_footer: "Thank you for visiting!"
            }
        };

        const BASEROW_TOKEN = "DfaoAk1o41H4iPUtkblY2ZKzXcbHxizb"; 
        const ORDERS_TABLE_ID = "37"; 
        const MENU_TABLE_ID = "36"; 
        const CALLS_TABLE_ID = "753"; 

        const CLIENTS_DB = {
            "demo": { adminPass: "123", kitchenPass: "k123", links: { kds: "api_mode", cashier: "api_mode", menu: "api_mode" } }
        };

        const STATE = {
            currentUser: null,
            currentRole: null, 
            currentLang: localStorage.getItem('rp_lang') || 'ar',
            pollingInterval: null, 
            knownOrders: {}, 
            isFirstFetch: true, 
            analyticsData: [], 
            lastFetchedOrders: [], 
            latestKdsOrders: [], 
            processedCashierOrders: [],
            activeCalls: [],
            activeCallRows: {},
            kdsActiveTab: 'tables',
            cashierStatusFilter: 'Ø¬Ø§Ù‡Ø²',
            currentCheckoutOrder: null,
            isMuted: false,
            selectedCashierDate: getLocalYYYYMMDD(),
            storageKeys: { username: "rp_username", role: "rp_role", lastView: "rp_last_view" }
        };

        function t(key) {
            return TRANSLATIONS[STATE.currentLang][key] || key;
        }

        // =========================================================
        // ğŸ”„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ØºØ© (Language Management)
        // =========================================================
        function setLanguage(lang) {
            STATE.currentLang = lang;
            localStorage.setItem('rp_lang', lang);
            
            const html = document.documentElement;
            html.lang = lang;
            html.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ·
            if (lang === 'ar') {
                html.style.fontFamily = "'Tajawal', sans-serif";
            } else {
                html.style.fontFamily = "system-ui, -apple-system, sans-serif";
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©
            updateLangUI(lang);
            
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ù†ØµÙˆØµ Ø§Ù„Ù€ Static UI
            updateStaticUI();
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const lastView = localStorage.getItem(STATE.storageKeys.lastView);
            if (lastView) loadView(lastView);

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±ÙˆØ¨ Ø¯Ø§ÙˆÙ†
            document.getElementById('lang-dropdown-header').classList.add('hidden');
            document.getElementById('lang-dropdown-login').classList.add('hidden');
        }

        function toggleLangDropdown(context) {
            const id = context === 'header' ? 'lang-dropdown-header' : 'lang-dropdown-login';
            document.getElementById(id).classList.toggle('hidden');
        }

        function updateLangUI(lang) {
            const flags = { ar: 'ğŸ‡©ğŸ‡¿', fr: 'ğŸ‡«ğŸ‡·', en: 'ğŸ‡ºğŸ‡¸' };
            const names = { ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', fr: 'FranÃ§ais', en: 'English' };
            
            document.getElementById('current-lang-flag').innerText = flags[lang];
            document.getElementById('current-lang-flag-login').innerText = flags[lang];
            document.getElementById('current-lang-name-login').innerText = names[lang];
        }

        function updateStaticUI() {
            // Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('login-subtitle').innerText = t('login_subtitle');
            document.getElementById('label-user').innerText = t('label_user');
            document.getElementById('label-pass').innerText = t('label_pass');
            document.getElementById('btn-login-text').innerText = t('btn_login');
            
            // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
            document.getElementById('nav-kds').innerText = t('nav_kds');
            document.getElementById('nav-cashier').innerText = t('nav_cashier');
            document.getElementById('nav-tables').innerText = t('nav_tables');
            document.getElementById('nav-menu').innerText = t('nav_menu');
            document.getElementById('nav-analytics').innerText = t('nav_analytics');
            
            // Ø¹Ù†Ø§ØµØ± Ù…ØªÙØ±Ù‚Ø©
            document.getElementById('logout-btn-text').innerText = t('logout');
            document.getElementById('welcome-title').innerText = t('welcome');
            document.getElementById('welcome-desc').innerText = t('choose');

            // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            document.getElementById('checkout-title').innerText = t('checkout');
            document.getElementById('checkout-amount-label').innerText = t('amount_label');
            document.getElementById('btn-confirm-print').innerText = t('btn_confirm_print');
            document.getElementById('btn-confirm-no-print').innerText = t('btn_confirm_no_print');
        }

        // =========================================================
        // ğŸ”„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª
        // =========================================================
        function getLocalYYYYMMDD() {
            const d = new Date();
            if (d.getHours() < 6) d.setDate(d.getDate() - 1);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            setLanguage(STATE.currentLang); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
            const savedUser = localStorage.getItem(STATE.storageKeys.username);
            const savedRole = localStorage.getItem(STATE.storageKeys.role);
            if (savedUser && savedRole && CLIENTS_DB[savedUser]) {
                authenticateUser(savedUser, CLIENTS_DB[savedUser].links, savedRole);
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('restaurantName').value.trim();
            const pass = document.getElementById('password').value;
            const data = CLIENTS_DB[user];
            let role = data && (pass === data.adminPass ? 'admin' : (pass === data.kitchenPass ? 'kitchen' : null));
            if (role) {
                localStorage.setItem(STATE.storageKeys.username, user);
                localStorage.setItem(STATE.storageKeys.role, role);
                authenticateUser(user, data.links, role);
                showToast(t('toast_success'));
            } else {
                showToast(t('toast_error'), 'error');
            }
        });

        function authenticateUser(user, links, role) {
            STATE.currentUser = user; STATE.currentRole = role; STATE.currentLinks = links;
            if (role === 'kitchen') sidebar.classList.add('hidden');
            else { sidebar.classList.remove('hidden'); fetchWaiterCalls(); STATE.waiterInterval = setInterval(fetchWaiterCalls, 5000); }
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'flex';
        }

        function logout() { localStorage.clear(); location.reload(); }

        // =========================================================
        // ğŸ–¥ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·Ø¨Ø® (KDS) Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù„ØºØ§Øª
        // =========================================================
        window.setKdsTab = (tab) => { STATE.kdsActiveTab = tab; renderKDS(STATE.latestKdsOrders); };

        function renderKDS(orders) {
            STATE.latestKdsOrders = orders;
            let filtered = orders.filter(o => isOrderFromToday(o['Created at'] || o.Time)).reverse();
            filtered = calculateDailySequence(filtered);
            filtered = processOrderAlerts(filtered);

            const activeOrders = filtered.filter(o => {
                const s = (typeof o.Status === 'object' ? o.Status.value : o.Status);
                return s === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' || s === 'Ø¬Ø§Ù‡Ø²';
            });

            const groups = { tables: Array.from({length: 15}, () => []), quick: [], delivery: [] };
            activeOrders.forEach(o => {
                const tableRaw = String(o.Table || '').toLowerCase();
                const tNum = parseInt(tableRaw.replace(/[^\d]/g, ''));
                if (tableRaw.includes('ØªÙˆØµÙŠÙ„') || tableRaw.includes('delivery')) groups.delivery.push(o);
                else if (tNum >= 1 && tNum <= 15) groups.tables[tNum-1].push(o);
                else groups.quick.push(o);
            });

            const hasNew = (arr) => arr.some(o => o.isNew);
            const content = document.getElementById('dynamic-content');
            content.innerHTML = '';
            content.className = "hidden flex-1 overflow-y-auto p-6 bg-gray-800 relative";

            const header = document.createElement('div');
            header.className = "flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 sticky top-0 bg-gray-800 py-4 -mx-6 -mt-6 px-6 pt-6 z-30 border-b border-gray-700 gap-4";
            
            const btnClass = (tab, newFlag) => `px-5 py-2 rounded-lg text-sm font-bold transition ${STATE.kdsActiveTab === tab ? 'bg-brand text-black' : (newFlag ? 'bg-red-600 animate-pulse text-white' : 'text-gray-400 hover:bg-gray-700')}`;

            header.innerHTML = `
                <div class="flex items-center gap-3"><h2 class="text-2xl font-bold text-white">${t('kds_title')}</h2><span class="live-indicator"></span></div>
                <div class="flex bg-gray-900 p-1 rounded-xl border border-gray-700 gap-1 flex-wrap">
                    <button onclick="setKdsTab('tables')" class="${btnClass('tables', groups.tables.some(hasNew))}">${t('tab_tables')}</button>
                    <button onclick="setKdsTab('quick')" class="${btnClass('quick', hasNew(groups.quick))}">${t('tab_quick')}</button>
                    <button onclick="setKdsTab('delivery')" class="${btnClass('delivery', hasNew(groups.delivery))}">${t('tab_delivery')}</button>
                </div>
            `;
            content.appendChild(header);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-10";

            if (STATE.kdsActiveTab === 'tables') {
                groups.tables.forEach((tOrders, i) => {
                    const card = document.createElement('div');
                    const tNum = i + 1;
                    if (tOrders.length === 0) {
                        card.className = "bg-green-900/10 border-2 border-green-800/30 rounded-2xl flex flex-col items-center justify-center h-48 opacity-60";
                        card.innerHTML = `<div class="text-4xl opacity-30">ğŸ½ï¸</div><div class="font-bold text-green-600">${t('tab_tables')} ${tNum}</div><div class="text-xs text-green-700">${t('table_empty')}</div>`;
                    } else {
                        const status = tOrders.some(o => (o.Status.value || o.Status) === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±') ? 'cooking' : 'ready';
                        const theme = status === 'cooking' ? 'border-red-500 shadow-red-900/20' : 'border-yellow-500 shadow-yellow-900/20';
                        card.className = `bg-gray-800 border-2 ${theme} rounded-2xl overflow-hidden shadow-lg`;
                        card.innerHTML = `<div class="${status === 'cooking' ? 'bg-red-600' : 'bg-yellow-500'} p-3 font-bold text-black flex justify-between"><span>${t('tab_tables')} ${tNum}</span><span>${tOrders.length}</span></div><div class="p-3">${renderOrderItems(tOrders)}</div>`;
                    }
                    grid.appendChild(card);
                });
            } else {
                const target = STATE.kdsActiveTab === 'quick' ? groups.quick : groups.delivery;
                target.forEach(o => {
                    const card = document.createElement('div');
                    const status = (o.Status.value || o.Status) === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' ? 'cooking' : 'ready';
                    const theme = status === 'cooking' ? 'border-brand' : 'border-yellow-500';
                    card.className = `bg-gray-800 border-2 ${theme} rounded-2xl overflow-hidden shadow-lg h-full`;
                    card.innerHTML = `<div class="bg-gray-700 p-3 font-bold">${t('order')} ${o.dailySequence}</div><div class="p-4 flex-1">${renderOrderItems([o])}</div>`;
                    grid.appendChild(card);
                });
            }
            content.appendChild(grid);
            content.classList.remove('hidden');
        }

        function renderOrderItems(orders) {
            return orders.map(o => {
                const status = (o.Status.value || o.Status);
                const btn = status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' ? `<button onclick="updateOrderStatus(${o.id}, 'Ø¬Ø§Ù‡Ø²')" class="w-full bg-green-600 py-2 rounded font-bold mt-2">${t('ready')}</button>` : `<div class="text-center text-green-500 font-bold py-2">${t('ready')}</div>`;
                return `<div class="bg-gray-900/50 p-2 rounded mb-2 border border-gray-700"><div class="flex justify-between text-xs text-gray-500 mb-1"><span>${o.dailySequence}</span><span>${formatOrderTime(o)}</span></div><div class="text-sm font-medium whitespace-pre-line">${o.Details}</div>${btn}</div>`;
            }).join('');
        }

        // =========================================================
        // ğŸ’° Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Cashier) Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ø§Ù„Ù„ØºØ©
        // =========================================================
        function renderCashier(orders) {
            STATE.lastFetchedOrders = orders;
            const content = document.getElementById('dynamic-content');
            content.innerHTML = '';

            let base = orders.filter(o => isOrderFromSelectedDate(o['Created at'] || o.Time, STATE.selectedCashierDate));
            base = calculateDailySequence(base);
            const filtered = base.filter(o => (o.Status.value || o.Status) === STATE.cashierStatusFilter);

            const getVal = (arr) => arr.reduce((acc, o) => acc + (parseFloat(o.Price) || 0), 0);
            const total = getVal(base);
            const avg = base.length ? (total / base.length).toFixed(0) : 0;

            const header = document.createElement('div');
            header.className = "flex flex-col md:flex-row justify-between items-start md:items-center mb-6 sticky top-0 bg-gray-800 py-4 -mx-6 -mt-6 px-6 pt-6 z-30 border-b border-gray-700 gap-4";
            header.innerHTML = `
                <div class="flex items-center gap-3"><h2 class="text-xl font-bold">${t('nav_cashier')}</h2><span class="live-indicator"></span></div>
                <input type="date" value="${STATE.selectedCashierDate}" onchange="STATE.selectedCashierDate=this.value;renderCashier(STATE.lastFetchedOrders)" class="bg-gray-900 border border-gray-700 px-3 py-1.5 rounded-lg outline-none cursor-pointer" style="color-scheme: dark;">
            `;
            content.appendChild(header);

            const kpi = document.createElement('div');
            kpi.className = "grid grid-cols-1 md:grid-cols-3 gap-6 mb-8";
            kpi.innerHTML = `
                <div class="bg-gray-800 p-5 rounded-xl border-r-4 border-brand shadow-lg"><p class="text-gray-400 text-sm mb-1">${t('total_sales')}</p><h3 class="text-3xl font-bold">${total.toLocaleString()} DA</h3></div>
                <div class="bg-gray-800 p-5 rounded-xl border-r-4 border-blue-500 shadow-lg"><p class="text-gray-400 text-sm mb-1">${t('total_orders')}</p><h3 class="text-3xl font-bold">${base.length}</h3></div>
                <div class="bg-gray-800 p-5 rounded-xl border-r-4 border-green-500 shadow-lg"><p class="text-gray-400 text-sm mb-1">${t('avg_cart')}</p><h3 class="text-3xl font-bold">${avg} DA</h3></div>
            `;
            content.appendChild(kpi);

            const filters = document.createElement('div');
            filters.className = "flex gap-2 mb-6 overflow-x-auto pb-2";
            ['Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±', 'Ø¬Ø§Ù‡Ø²', 'Ù…Ø¯ÙÙˆØ¹'].forEach(s => {
                const label = s === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' ? t('cooking') : (s === 'Ø¬Ø§Ù‡Ø²' ? t('ready') : t('paid'));
                const active = STATE.cashierStatusFilter === s;
                filters.innerHTML += `<button onclick="STATE.cashierStatusFilter='${s}';renderCashier(STATE.lastFetchedOrders)" class="px-5 py-2 rounded-xl text-sm transition ${active ? 'bg-brand text-black font-bold' : 'bg-gray-900 text-gray-400'}">${label}</button>`;
            });
            content.appendChild(filters);

            const table = document.createElement('div');
            table.className = "bg-gray-900 rounded-xl overflow-hidden border border-gray-700";
            let html = `<table class="w-full text-right text-sm"><thead><tr class="bg-gray-800 text-gray-400"><th class="p-4">#</th><th class="p-4">${t('order')}</th><th class="p-4">DA</th><th class="p-4">Action</th></tr></thead><tbody class="divide-y divide-gray-800">`;
            filtered.forEach(o => {
                const s = (o.Status.value || o.Status);
                const action = s === 'Ø¬Ø§Ù‡Ø²' ? `<button onclick="handlePaymentToggle(${o.id})" class="bg-brand text-black px-3 py-1 rounded-full font-bold">${t('checkout')}</button>` : `<span class="opacity-50">${s}</span>`;
                html += `<tr><td class="p-4 font-mono">${o.dailySequence}</td><td class="p-4">${o.Table || 'Quick'}</td><td class="p-4 font-bold text-white">${parseFloat(o.Price).toLocaleString()}</td><td class="p-4">${action}</td></tr>`;
            });
            html += `</tbody></table>`;
            table.innerHTML = html;
            content.appendChild(table);
            content.classList.remove('hidden');
        }

        // =========================================================
        // ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Analytics) Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¨Ø§Ù„Ù„ØºØ©
        // =========================================================
        async function renderAnalytics(orders = STATE.analyticsData, type = 'today') {
            const content = document.getElementById('dynamic-content');
            content.innerHTML = `<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 sticky top-0 bg-gray-800 py-4 -mx-6 -mt-6 px-6 pt-6 z-30 border-b border-gray-700 gap-4"><h2 class="text-2xl font-bold">${t('nav_analytics')}</h2></div>`;
            
            const filtered = orders.filter(o => type === 'today' ? isOrderFromToday(o['Created at'] || o.Time) : true);
            const total = filtered.reduce((acc, o) => acc + (parseFloat(o.Price) || 0), 0);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 gap-8 pb-10";
            grid.innerHTML = `<div class="bg-gray-900 p-6 rounded-2xl border border-gray-700 h-64"><h3 class="mb-4 font-bold">Chart Title</h3><canvas id="lineChart"></canvas></div>`;
            content.appendChild(grid);
            
            content.classList.remove('hidden');
            // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù‡Ù†Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Chart.js ÙˆÙŠØ­ØªØ§Ø¬ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Labels
        }

        // =========================================================
        // Helpers & Utils
        // =========================================================
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `bg-gray-800 text-white px-4 py-3 rounded-lg shadow-2xl border-l-4 ${type==='success'?'border-green-500':'border-red-500'} transition-all transform translate-x-full`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => { toast.classList.add('translate-x-full'); setTimeout(()=>toast.remove(), 500); }, 3000);
        }

        function formatOrderTime(o) {
            const raw = o['Created at'] || o.Time;
            if (!raw) return '--:--';
            return new Date(raw).toLocaleTimeString(STATE.currentLang === 'ar' ? 'ar-DZ' : 'en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        async function handlePaymentToggle(id) {
            const order = STATE.processedCashierOrders.find(o => o.id === id);
            if (!order) return;
            STATE.currentCheckoutOrder = order;
            document.getElementById('checkout-amount').innerText = `${parseFloat(order.Price).toLocaleString()} DA`;
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        function closeCheckoutModal() { document.getElementById('checkout-modal').classList.add('hidden'); }

        async function confirmPayment(print) {
            const o = STATE.currentCheckoutOrder;
            if (!o) return;
            closeCheckoutModal();
            if (print) printReceipt(o);
            
            // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙØ§Ø¦Ù„
            updateOrderStatus(o.id, 'Ù…Ø¯ÙÙˆØ¹');
        }

        function printReceipt(o) {
            const printSec = document.getElementById('print-section');
            const items = o.Details.split('\n').map(i => `<div>${i}</div>`).join('');
            printSec.innerHTML = `
                <div style="text-align:center"><h2>RestoPro</h2><p>${t('receipt_header')}</p></div>
                <hr/><div style="display:flex; justify-content:space-between"><span># ${o.dailySequence}</span><span>${o.Table || 'Quick'}</span></div>
                <div style="font-size:10px">${new Date().toLocaleString()}</div><hr/>
                <div>${items}</div><hr/>
                <div style="font-size:16px; font-weight:bold; display:flex; justify-content:space-between"><span>TOTAL</span><span>${o.Price} DA</span></div>
                <hr/><div style="text-align:center; font-size:10px">${t('receipt_footer')}</div>
            `;
            window.print();
        }

        async function loadView(view) {
            if (window.innerWidth < 768) { sidebar.classList.add('translate-x-full'); document.getElementById('sidebar-overlay')?.classList.add('hidden'); }
            if (STATE.pollingInterval) clearInterval(STATE.pollingInterval);
            localStorage.setItem(STATE.storageKeys.lastView, view);
            updateNavStyles(view);
            welcomeState.style.display = 'none';
            loader.classList.remove('hidden');
            
            try {
                if (view === 'kds' || view === 'cashier') {
                    const data = await fetchOrders(ORDERS_TABLE_ID);
                    if (view === 'kds') { renderKDS(data); STATE.pollingInterval = setInterval(async () => renderKDS(await fetchOrders(ORDERS_TABLE_ID)), 10000); }
                    else { renderCashier(data); STATE.pollingInterval = setInterval(async () => renderCashier(await fetchOrders(ORDERS_TABLE_ID)), 10000); }
                } else if (view === 'tables') { renderTableView(); }
                else if (view === 'analytics') { renderAnalytics(await fetchOrders(ORDERS_TABLE_ID)); }
            } catch (e) { showToast(t('toast_error'), 'error'); }
            finally { loader.classList.add('hidden'); }
        }

        function updateNavStyles(view) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-brand', 'text-black'));
            const active = document.getElementById(`btn-${view}`);
            if (active) active.classList.add('bg-brand', 'text-black');
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø¬Ø±Ø³ Ø§Ù„Ù†Ø§Ø¯Ù„ ÙˆØ§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
        async function fetchWaiterCalls() {
            try {
                const res = await fetch(`https://baserow.vidsai.site/api/database/rows/table/${CALLS_TABLE_ID}/?user_field_names=true`, { headers: { "Authorization": `Token ${BASEROW_TOKEN}` } });
                const data = await res.json();
                const active = data.results.filter(r => (r.status.value || r.status) === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                const tBadge = document.getElementById('tables-badge');
                if (active.length > 0) {
                    tBadge.classList.remove('hidden');
                    if (!STATE.isMuted && active.length > STATE.activeCalls.length) new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play();
                } else tBadge.classList.add('hidden');
                STATE.activeCalls = active;
            } catch(e){}
        }

        async function resolveTableCall(id) { /* Ù…Ù†Ø·Ù‚ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø¯Ø§Ø¡ */ }
        function calculateElapsedMinutes(raw) { return raw ? Math.floor((new Date() - new Date(raw))/60000) : 0; }
        function updateNavStyles(active) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('bg-brand', b.id === `btn-${active}`)); }

    </script>
</body>
</html>